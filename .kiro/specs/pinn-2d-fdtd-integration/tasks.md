# 実装計画

## タスク概要

本ドキュメントは、2D弾性波PINN-FDTD統合機能の実装タスクを定義します。Phase 1基盤を再利用しつつ、無次元化による損失スケール問題対策、2D geometry対応、パラメトリック学習を実現します。

## 実装タスク

- [x] 1. 無次元化スケーラーの実装
- [x] 1.1 (P) 特性スケール計算機能の実装
  - 物理パラメータ(λ, μ, ρ, domain_length)から特性スケール(L_ref, T_ref, U_ref, σ_ref)を計算する
  - 縦波速度c_l = sqrt((λ+2μ)/ρ)から時間スケールT_ref = L_ref/c_lを導出する
  - 特性インピーダンスσ_ref = ρ*c_l²を計算する
  - FDTDデータ統計からU_refを自動推定するオプションを提供する（compute_U_ref_from_data=true時）
  - _Requirements: 1.1, 1.5_

- [x] 1.2 (P) 入出力変数の無次元化機能の実装
  - 空間座標(x, y)および時間座標(t)をL_ref, T_refで無次元化する
  - 応力場(T1, T3)をσ_refで無次元化する
  - 変位場(Ux, Uy)をU_refで無次元化する
  - 無次元化された変数が全てO(1)スケールになることを検証する
  - _Requirements: 1.1_

- [x] 1.3 (P) 物理単位への逆変換機能の実装
  - 無次元化された出力(T̃1, T̃3, Ũx, Ũy)を物理単位(Pa, m)に変換する
  - 可視化および検証時に使用する逆変換APIを提供する
  - normalize→denormalizeで元の値が復元されることを単体テストで確認する
  - _Requirements: 4.4, 4.6_

- [x] 2. 2D弾性波PDEと幾何定義の実装
- [x] 2.1 (P) 2D Rectangle geometryの構築
  - DeepXDE Rectangle([0, 0], [0.04, 0.02])で2D空間ドメインを定義する
  - TimeDomain(3.5e-6, 6.5e-6)で時間ドメインを定義する
  - GeometryXTime(spatial_geom, timedomain)で3D(x,y,t)時空間ドメインを作成する
  - Phase 1のInterval geometryからRectangleへの移行を実装する
  - _Requirements: 1.2, 1.4_

- [x] 2.2 (P) 無次元2D弾性波PDE residualの実装
  - 無次元縦波方程式∂²Ũx/∂t̃² - (∂²Ũx/∂x̃² + ∂²Ũx/∂ỹ²) = 0を実装する（係数=1）
  - 無次元横波方程式∂²Ũy/∂t̃² - (c_t/c_l)²(∂²Ũy/∂x̃² + ∂²Ũy/∂ỹ²) = 0を実装する（係数≈0.24）
  - DeepXDE hessian APIで2階微分(component, i, j指定)を計算する
  - 応力residualは簡略化(ゼロ)とし、FDTDデータ監視損失に依存する
  - PDE係数がO(1)であることを単体テストで検証する
  - _Requirements: 1.1, 1.5_

- [x] 2.3 (P) 5D入力4D出力ニューラルネットワークの構築
  - 入力次元[5]（x̃, ỹ, t̃, pitch_norm, depth_norm）のFNNを構築する
  - 出力次元[4]（T̃1, T̃3, Ũx, Ũy）のマルチ出力ネットワークを構築する
  - 隠れ層[64, 64, 64]、活性化関数tanh、Glorot初期化を設定する
  - Phase 1のlayer_sizes [2, 50, 50, 50, 1]から[5, 64, 64, 64, 4]への変更を実装する
  - _Requirements: 1.3, 3.1, 3.2_

- [ ] 3. FDTDデータローディングとパラメータ正規化
- [x] 3.1 複数.npzファイルの読み込みと結合
  - Phase 1のload_file()を再利用して個別ファイルを読み込む
  - pitch範囲[1.25mm, 2.0mm]およびdepth範囲[0.1mm, 0.3mm]でフィルタリングする
  - 12ファイル（4 pitch × 3 depth）のデータを単一データセットに結合する
  - 空間座標(x, y)、時間(t)、波動場(T1, T3, Ux, Uy)を抽出する
  - メタデータ(pitch, depth, seed)を各サンプルに付加する
  - _Requirements: 2.1, 2.2, 2.3, 3.3_

- [x] 3.2 パラメータ正規化機能の実装
  - pitch正規化: (p - 1.25e-3) / (2.0e-3 - 1.25e-3) → [0, 1]を実装する
  - depth正規化: (d - 0.1e-3) / (0.3e-3 - 0.1e-3) → [0, 1]を実装する
  - 逆正規化機能を提供し、推論時のパラメータ復元を可能にする
  - 範囲外値をclipまたはValueErrorで処理する
  - _Requirements: 3.1, 3.2_

- [ ] 3.3 訓練/検証データ分割の実装
  - 全12ファイルのデータを訓練に使用する
  - 検証データは訓練データと同一とする（初期段階ではoverfitting確認が目的）
  - または、各ファイル内の時空間サンプル点を80/20分割する（seed=42、オプション）
  - PyTorch DataLoaderへの変換を実装する
  - 将来データ量が増加した場合、holdoutパラメータ戦略を導入する拡張性を残す
  - _Requirements: 2.4, 2.5, 3.3, 3.5_

- [ ] 3.4 データローディングパイプライン統合
  - FDTDDataLoaderServiceにload_multiple_files()メソッドを追加する
  - 無次元化スケーラーを適用して全変数をO(1)スケールに変換する
  - パラメータ正規化を適用してpitch, depthを[0, 1]に変換する
  - エラーハンドリング（FileNotFoundError, KeyError, ValueError）を実装する
  - データ読み込み時間が10秒以内であることをパフォーマンステストで確認する
  - _Requirements: 2.1, 2.3, 2.6, 2.7, 3.1, 3.2_

- [ ] 4. R²スコア検証機能の実装
- [ ] 4.1 (P) R²スコア計算機能の追加
  - sklearn.metrics.r2_scoreをラッパーするr2_score()メソッドを実装する
  - per_output=trueで各出力場(T1, T3, Ux, Uy)のR²を個別に計算する
  - R² = 1 - SS_res / SS_totの計算を実装する
  - sklearnが未インストール時にImportErrorを適切に処理する
  - _Requirements: 4.1, 4.2, 4.3_

- [ ] 4.2 (P) 訓練中のR²モニタリングコールバックの実装
  - ValidationCallbackクラスを新規作成する
  - epoch終了時にvalidationデータでR²を計算する
  - 各出力場のR²をログに記録する（log_interval=1000 epochs）
  - R² < 0.9の場合に警告メッセージを出力する
  - ハイパーパラメータ調整推奨メッセージを表示する
  - _Requirements: 3.5, 4.3, 4.5_

- [ ] 4.3 (P) 時系列スナップショット可視化の実装
  - 複数時刻（最低3時刻）での波動場空間分布プロットを生成する
  - FDTDとPINN予測を並列表示するマルチパネルプロットを作成する
  - 物理単位への逆変換後に可視化を実施する
  - 各出力場(T1, T3, Ux, Uy)に対応するプロットを生成する
  - _Requirements: 4.4, 7.4_

- [ ] 4.4 (P) 誤差分布ヒートマップの実装
  - 空間領域全体での絶対誤差|PINN - FDTD|のヒートマップを生成する
  - 各出力場に対して誤差分布を可視化する
  - 誤差が集中する領域を特定可能にする
  - MatplotlibまたはSeabornでヒートマップを描画する
  - _Requirements: 4.6_

- [ ] 5. 2D PINN訓練パイプライン構築
- [ ] 5.1 PINNModelBuilder2DServiceの実装
  - Phase 1のPINNModelBuilderServiceを継承する
  - _create_geometry()を2D Rectangle + TimeDomainにオーバーライドする
  - _create_network()で[5, 64, 64, 64, 4]のFNNを構築する
  - PDEDefinition2DService.create_pde_function()からPDE関数を取得する
  - 弾性定数(λ, μ, ρ)を設定から読み込む
  - _Requirements: 1.2, 1.3, 1.4, 1.5, 3.1, 3.2_

- [ ] 5.2 訓練CLIスクリプトの実装
  - train_2d.pyエントリーポイントを作成する
  - YAML設定ファイルからconfig読み込みを実装する
  - FDTDデータロード→無次元化→train/val分割のフローを実装する
  - PINNModelBuilder2DServiceでモデル構築を実行する
  - TrainingPipelineService（Phase 1再利用）で訓練を実行する
  - ValidationCallbackを登録してR²モニタリングを有効化する
  - _Requirements: 5.1, 5.2, 5.4, 8.1, 8.3, 8.6_

- [ ] 5.3 損失重み初期値設定と検証
  - 無次元化によりw_data=1.0, w_pde=1.0, w_bc=0.0から開始する
  - 訓練初期にdata loss, PDE loss, BC lossのオーダーをログ記録する
  - 全損失項がO(1)であることを確認する
  - 損失不均衡が解消されたことをログで検証する
  - _Requirements: 5.1_

- [ ] 6. 統合テストと検証
- [ ] 6.1 PDE residual計算の単体テスト
  - 無次元PDE係数が1および(c_t/c_l)²であることを検証する
  - Hessian計算の次元とcomponent indexを確認する
  - c_ratio = c_t/c_l ≈ 0.49（Al 6061）を検証する
  - _Requirements: 6.1_

- [ ] 6.2 FDTDデータローディングの単体テスト
  - 複数ファイル結合時の配列長整合性を検証する
  - パラメータフィルタリング正確性を確認する
  - 不正形式ファイル時のValueError発生を確認する
  - _Requirements: 6.1_

- [ ] 6.3 R²スコア計算の単体テスト
  - 完全一致でR²=1.0を確認する
  - ランダム予測でR²≈0を確認する
  - per-field R²計算の正確性を検証する
  - _Requirements: 6.1_

- [ ] 6.4 無次元化の単体テスト
  - normalize→denormalizeで元の値復元を確認する
  - 範囲境界値(1.25, 2.0, 0.1, 0.3)の正確性を検証する
  - 特性スケール計算の正確性を確認する
  - _Requirements: 6.1_

- [ ] 6.5 エンドツーエンド統合テスト
  - 2ファイル（p1250_d100, p1500_d200）で小規模訓練を実行する
  - 100 epochs訓練してR²スコア計算成功を確認する
  - チェックポイント保存を確認する
  - 実データを用いた実行可能なテストを優先する（Phase 1反省）
  - _Requirements: 6.2, 6.4_

- [ ] 7. Jupyter Notebookデモ実装
- [ ] 7.1 順問題Notebookの作成
  - wave_2d_forward_demo.ipynbを作成する
  - Phase 1のwave_1d_demo.ipynbテンプレート構造を再利用する
  - FDTDデータ読み込み→2D PINN訓練→FDTD比較プロットの完全ワークフローを実装する
  - 単一パラメータ組み合わせ（例: p1250_d100）で訓練を実行する
  - _Requirements: 7.1, 7.2, 7.3_

- [ ] 7.2 可視化セルの実装
  - 最低3時刻の時系列スナップショットを生成する
  - 変位分布(Ux, Uy)または応力分布(T1, T3)を可視化する
  - FDTDとPINNの空間分布を並列表示する
  - R²スコアを計算して表示する
  - _Requirements: 7.4, 7.5_

- [ ] 7.3 最小限の説明セルの追加
  - Notebookの冒頭に概要を1-2セルで簡潔に説明（日本語）
  - 各セクションに1行の目的コメント程度（日本語）
  - コード内コメントは全て英語で記述
  - 実装コードと完全に一致するAPIを使用する（import path, メソッド名の整合性保証）
  - _Requirements: 7.6, 7.7_

- [ ] 7.4 Notebook実行検証
  - 全セルをエラーなく完了できることを確認する
  - 時系列スナップショットおよびR²スコアが生成されることを確認する
  - 実装コードとnotebookの整合性を維持する（Phase 1反省）
  - _Requirements: 6.3, 6.5, 7.5, 7.7_

- [ ] 8. 設定ファイルと実験管理の整備
- [ ] 8.1 (P) 2D PINN用YAML設定ファイルの作成
  - configs/2d_elastic_wave.yamlを作成する
  - domain設定（x, y, t範囲、弾性定数λ, μ, ρ）を定義する
  - characteristic_scales設定（L_ref, U_ref, compute_U_ref_from_data）を追加する
  - network設定（layer_sizes: [5, 64, 64, 64, 4]）を定義する
  - training設定（epochs, learning_rate, loss_weights）を定義する
  - _Requirements: 1.5, 5.3_

- [ ] 8.2 (P) メタデータロガーの拡張
  - MetadataLoggerを拡張してFDTDファイルリストを記録する
  - パラメータ範囲(pitch, depth)をメタデータに追加する
  - 特性スケール(L_ref, T_ref, U_ref, σ_ref)を記録する
  - Phase 1のMetadataLoggerを継承して実装する
  - _Requirements: 8.2, 8.4_

- [ ] 8.3 (P) 実験ディレクトリ管理の再利用
  - Phase 1のExperimentManagerをそのまま使用する
  - タイムスタンプ付き実験ディレクトリ作成を実施する
  - チェックポイント、ログ、プロットを/experiments/exp_{timestamp}/に保存する
  - seed=42設定による再現性を保証する
  - _Requirements: 8.1, 8.3, 8.5, 8.6_

## 要求カバレッジ検証

### 要求1: 2D弾性波方程式PINNモデル
- 1.1: タスク1.1, 1.2, 2.2
- 1.2: タスク2.1, 5.1
- 1.3: タスク2.3, 5.1
- 1.4: タスク2.1, 5.1
- 1.5: タスク1.1, 2.2, 5.1, 8.1

### 要求2: FDTDデータローディングと訓練統合
- 2.1: タスク3.1, 3.4, 6.2
- 2.2: タスク3.1
- 2.3: タスク3.1, 3.4
- 2.4: タスク3.3
- 2.5: タスク3.3
- 2.6: タスク3.4
- 2.7: タスク3.4

### 要求3: パラメトリックPINN学習
- 3.1: タスク2.3, 3.2, 5.1
- 3.2: タスク2.3, 3.2, 5.1
- 3.3: タスク3.1, 3.3
- 3.4: 推論機能（実装タスクに含まれる）
- 3.5: タスク3.3, 4.2
- 3.6: 設計文書で認識済み

### 要求4: FDTDデータとの比較検証
- 4.1: タスク4.1
- 4.2: タスク4.1
- 4.3: タスク4.1, 4.2
- 4.4: タスク4.3, 7.2
- 4.5: タスク4.2
- 4.6: タスク4.4

### 要求5: Phase 1基盤コンポーネントの再利用
- 5.1: タスク5.2, 5.3
- 5.2: タスク5.2
- 5.3: タスク5.2, 8.1
- 5.4: タスク5.2
- 5.5: Phase 1コンポーネント再利用
- 5.6: 全タスクでディレクトリ構造維持

### 要求6: 簡素化されたテスト戦略
- 6.1: タスク6.1, 6.2, 6.3, 6.4
- 6.2: タスク6.5
- 6.3: タスク7.4
- 6.4: タスク6.5
- 6.5: タスク7.4
- 6.6: テストタスク全体で50%カバレッジ目標

### 要求7: Jupyter Notebookデモンストレーション
- 7.1: タスク7.1
- 7.2: タスク7.1
- 7.3: タスク7.1
- 7.4: タスク7.2
- 7.5: タスク7.2, 7.4
- 7.6: タスク7.3
- 7.7: タスク7.3, 7.4
- 7.8: 設計文書で認識済み（逆問題はPhase 2スコープ外）

### 要求8: 再現性と実験管理
- 8.1: タスク8.3
- 8.2: タスク8.2
- 8.3: タスク5.2, 8.3
- 8.4: タスク8.2
- 8.5: タスク8.3
- 8.6: タスク5.2, 8.3

## 実装順序の推奨

### Phase A: 基盤実装（並列実行可能）
1. タスク1（無次元化スケーラー）
2. タスク2.1-2.2（2D geometry + PDE）
3. タスク3.2（パラメータ正規化）

### Phase B: データ統合
4. タスク3.1, 3.3, 3.4（FDTDデータローディング）
5. タスク2.3（5D入力4D出力ネットワーク）

### Phase C: 訓練パイプライン
6. タスク5.1, 5.2, 5.3（PINN訓練）
7. タスク4.1, 4.2（R²モニタリング）

### Phase D: 検証とデモ
8. タスク4.3, 4.4（可視化）
9. タスク6（テスト）
10. タスク7（Notebook）
11. タスク8（設定・実験管理）

## 注意事項

- タスク1, 2.1, 2.2, 3.2, 4.1, 4.2, 4.3, 4.4, 8.1, 8.2, 8.3には(P)マーカーが付与されており、並列実行が可能です
- Phase 1コンポーネント（TrainingPipelineService, AMPWrapperService, ConfigLoaderService等）は既存実装を再利用します
- 無次元化による損失スケール問題対策が重要な設計判断であり、タスク1で最優先実装します
- テストは重要機能に絞り（要求6）、50%カバレッジ目標とします
- Notebookと実装コードの整合性を維持します（Phase 1反省）
